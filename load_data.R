#Source the data loading
library(tidyverse)
library(shiny)
library(fst)
library(hms)
library(bslib)
library(vroom)
library(ggplot2)
library(ggridges)
library(viridis)
library(gridExtra)
library(DT)
library(shinycssloaders)
library(colourpicker)

# Data loading code same as before
if (!exists("nfl_raw")) {
  nfl_raw <- vroom("NFL Play by Play 2009-2018 (v5).csv",
                   delim = ",",
                   col_types = cols(
                     play_id = col_integer(),
                     game_id = col_character(),
                     home_team = col_character(),
                     away_team = col_character(),
                     posteam = col_character(),
                     posteam_type = col_character(),
                     defteam = col_character(),
                     side_of_field = col_character(),
                     yardline_100 = col_integer(),
                     game_date = col_date(format = "%Y-%m-%d"),
                     quarter_seconds_remaining = col_integer(),
                     half_seconds_remaining = col_integer(),
                     game_seconds_remaining = col_integer(),
                     game_half = col_character(),
                     quarter_end = col_logical(),
                     drive = col_integer(),
                     sp = col_logical(),
                     qtr = col_integer(),
                     down = col_integer(),
                     goal_to_go = col_logical(),
                     time = col_time(format = "%M:%S"),
                     yrdln = col_character(),
                     ydstogo = col_integer(),
                     ydsnet = col_integer(),
                     desc = col_character(),
                     play_type = col_character(),
                     yards_gained = col_integer(),
                     shotgun = col_logical(),
                     no_huddle = col_logical(),
                     qb_dropback = col_logical(),
                     qb_kneel = col_logical(),
                     qb_spike = col_logical(),
                     qb_scramble = col_logical(),
                     pass_length = col_character(),
                     pass_location = col_character(),
                     air_yards = col_integer(),
                     yards_after_catch = col_integer(),
                     run_location = col_character(),
                     run_gap = col_character(),
                     field_goal_result = col_character(),
                     kick_distance = col_integer(),
                     extra_point_result = col_character(),
                     two_point_conv_result = col_character(),
                     home_timeouts_remaining = col_integer(),
                     away_timeouts_remaining = col_integer(),
                     timeout = col_logical(),
                     timeout_team = col_character(),
                     td_team = col_character(),
                     posteam_timeouts_remaining = col_integer(),
                     defteam_timeouts_remaining = col_integer(),
                     total_home_score = col_integer(),
                     total_away_score = col_integer(),
                     posteam_score = col_integer(),
                     defteam_score = col_integer(),
                     score_differential = col_integer(),
                     posteam_score_post = col_integer(),
                     defteam_score_post = col_integer(),
                     score_differential_post = col_integer(),
                     no_score_prob = col_double(),
                     opp_fg_prob = col_double(),
                     opp_safety_prob = col_double(),
                     opp_td_prob = col_double(),
                     fg_prob = col_double(),
                     safety_prob = col_double(),
                     td_prob = col_double(),
                     extra_point_prob = col_double(),
                     two_point_conversion_prob = col_double(),
                     ep = col_double(),
                     epa = col_double(),
                     total_home_epa = col_double(),
                     total_away_epa = col_double(),
                     total_home_rush_epa = col_double(),
                     total_away_rush_epa = col_double(),
                     total_home_pass_epa = col_double(),
                     total_away_pass_epa = col_double(),
                     air_epa = col_double(),
                     yac_epa = col_double(),
                     comp_air_epa = col_double(),
                     comp_yac_epa = col_double(),
                     total_home_comp_air_epa = col_double(),
                     total_away_comp_air_epa = col_double(),
                     total_home_comp_yac_epa = col_double(),
                     total_away_comp_yac_epa = col_double(),
                     total_home_raw_air_epa = col_double(),
                     total_away_raw_air_epa = col_double(),
                     total_home_raw_yac_epa = col_double(),
                     total_away_raw_yac_epa = col_double(),
                     wp = col_double(),
                     def_wp = col_double(),
                     home_wp = col_double(),
                     away_wp = col_double(),
                     wpa = col_double(),
                     home_wp_post = col_double(),
                     away_wp_post = col_double(),
                     total_home_rush_wpa = col_double(),
                     total_away_rush_wpa = col_double(),
                     total_home_pass_wpa = col_double(),
                     total_away_pass_wpa = col_double(),
                     air_wpa = col_double(),
                     yac_wpa = col_double(),
                     comp_air_wpa = col_double(),
                     comp_yac_wpa = col_double(),
                     total_home_comp_air_wpa = col_double(),
                     total_away_comp_air_wpa = col_double(),
                     total_home_comp_yac_wpa = col_double(),
                     total_away_comp_yac_wpa = col_double(),
                     total_home_raw_air_wpa = col_double(),
                     total_away_raw_air_wpa = col_double(),
                     total_home_raw_yac_wpa = col_double(),
                     total_away_raw_yac_wpa = col_double(),
                     punt_blocked = col_logical(),
                     first_down_rush = col_logical(),
                     first_down_pass = col_logical(),
                     first_down_penalty = col_logical(),
                     third_down_converted = col_logical(),
                     third_down_failed = col_logical(),
                     fourth_down_converted = col_logical(),
                     fourth_down_failed = col_logical(),
                     incomplete_pass = col_logical(),
                     interception = col_logical(),
                     touchback = col_logical(),
                     punt_inside_twenty = col_logical(),
                     punt_in_endzone = col_logical(),
                     punt_out_of_bounds = col_logical(),
                     punt_downed = col_logical(),
                     punt_fair_catch = col_logical(),
                     kickoff_inside_twenty = col_logical(),
                     kickoff_in_endzone = col_logical(),
                     kickoff_out_of_bounds = col_logical(),
                     kickoff_downed = col_logical(),
                     kickoff_fair_catch = col_logical(),
                     fumble_forced = col_logical(),
                     fumble_not_forced = col_logical(),
                     fumble_out_of_bounds = col_logical(),
                     solo_tackle = col_logical(),
                     safety = col_logical(),
                     penalty = col_logical(),
                     tackled_for_loss = col_logical(),
                     fumble_lost = col_logical(),
                     own_kickoff_recovery = col_logical(),
                     own_kickoff_recovery_td = col_logical(),
                     qb_hit = col_logical(),
                     rush_attempt = col_logical(),
                     pass_attempt = col_logical(),
                     sack = col_logical(),
                     touchdown = col_logical(),
                     pass_touchdown = col_logical(),
                     rush_touchdown = col_logical(),
                     return_touchdown = col_logical(),
                     extra_point_attempt = col_logical(),
                     two_point_attempt = col_logical(),
                     field_goal_attempt = col_logical(),
                     kickoff_attempt = col_logical(),
                     punt_attempt = col_logical(),
                     fumble = col_logical(),
                     complete_pass = col_logical(),
                     assist_tackle = col_logical(),
                     lateral_reception = col_logical(),
                     lateral_rush = col_logical(),
                     lateral_return = col_logical(),
                     lateral_recovery = col_logical(),
                     passer_player_id = col_character(),
                     passer_player_name = col_character(),
                     receiver_player_id = col_character(),
                     receiver_player_name = col_character(),
                     rusher_player_id = col_character(),
                     rusher_player_name = col_character(),
                     lateral_receiver_player_id = col_character(),
                     lateral_receiver_player_name = col_character(),
                     lateral_rusher_player_id = col_character(),
                     lateral_rusher_player_name = col_character(),
                     lateral_sack_player_id = col_character(),
                     lateral_sack_player_name = col_character(),
                     interception_player_id = col_character(),
                     interception_player_name = col_character(),
                     lateral_interception_player_id = col_character(),
                     lateral_interception_player_name = col_character(),
                     punt_returner_player_id = col_character(),
                     punt_returner_player_name = col_character(),
                     lateral_punt_returner_player_id = col_character(),
                     lateral_punt_returner_player_name = col_character(),
                     kickoff_returner_player_id = col_character(),
                     kickoff_returner_player_name = col_character(),
                     lateral_kickoff_returner_player_id = col_character(),
                     lateral_kickoff_returner_player_name = col_character(),
                     punter_player_id = col_character(),
                     punter_player_name = col_character(),
                     kicker_player_id = col_character(),
                     kicker_player_name = col_character(),
                     own_kickoff_recovery_player_id = col_character(),
                     own_kickoff_recovery_player_name = col_character(),
                     blocked_player_id = col_character(),
                     blocked_player_name = col_character(),
                     tackle_for_loss_1_player_id = col_character(),
                     tackle_for_loss_1_player_name = col_character(),
                     tackle_for_loss_2_player_id = col_character(),
                     tackle_for_loss_2_player_name = col_character(),
                     qb_hit_1_player_id = col_character(),
                     qb_hit_1_player_name = col_character(),
                     qb_hit_2_player_id = col_character(),
                     qb_hit_2_player_name = col_character(),
                     forced_fumble_player_1_team = col_character(),
                     forced_fumble_player_1_player_id = col_character(),
                     forced_fumble_player_1_player_name = col_character(),
                     forced_fumble_player_2_team = col_character(),
                     forced_fumble_player_2_player_id = col_character(),
                     forced_fumble_player_2_player_name = col_character(),
                     solo_tackle_1_team = col_character(),
                     solo_tackle_2_team = col_character(),
                     solo_tackle_1_player_id = col_character(),
                     solo_tackle_2_player_id = col_character(),
                     solo_tackle_1_player_name = col_character(),
                     solo_tackle_2_player_name = col_character(),
                     assist_tackle_1_player_id = col_character(),
                     assist_tackle_1_player_name = col_character(),
                     assist_tackle_1_team = col_character(),
                     assist_tackle_2_player_id = col_character(),
                     assist_tackle_2_player_name = col_character(),
                     assist_tackle_2_team = col_character(),
                     assist_tackle_3_player_id = col_character(),
                     assist_tackle_3_player_name = col_character(),
                     assist_tackle_3_team = col_character(),
                     assist_tackle_4_player_id = col_character(),
                     assist_tackle_4_player_name = col_character(),
                     assist_tackle_4_team = col_character(),
                     pass_defense_1_player_id = col_character(),
                     pass_defense_1_player_name = col_character(),
                     pass_defense_2_player_id = col_character(),
                     pass_defense_2_player_name = col_character(),
                     fumbled_1_team = col_character(),
                     fumbled_1_player_id = col_character(),
                     fumbled_1_player_name = col_character(),
                     fumbled_2_player_id = col_character(),
                     fumbled_2_player_name = col_character(),
                     fumbled_2_team = col_character(),
                     fumble_recovery_1_team = col_character(),
                     fumble_recovery_1_yards = col_integer(),
                     fumble_recovery_1_player_id = col_character(),
                     fumble_recovery_1_player_name = col_character(),
                     fumble_recovery_2_team = col_character(),
                     fumble_recovery_2_yards = col_integer(),
                     fumble_recovery_2_player_id = col_character(),
                     fumble_recovery_2_player_name = col_character(),
                     return_team = col_character(),
                     return_yards = col_integer(),
                     penalty_team = col_character(),
                     penalty_player_id = col_character(),
                     penalty_player_name = col_character(),
                     penalty_yards = col_integer(),
                     replay_or_challenge = col_logical(),
                     replay_or_challenge_result = col_character(),
                     penalty_type = col_character(),
                     defensive_two_point_attempt = col_logical(),
                     defensive_two_point_conv = col_logical(),
                     defensive_extra_point_attempt = col_logical(),
                     defensive_extra_point_conv = col_logical()
                   )
  )|>
    select(play_id, game_id, posteam, defteam, home_team, away_team, qtr, quarter_seconds_remaining,
           sp, down, time, ydsnet, play_type, score_differential, yards_gained, field_goal_result,
           field_goal_attempt, defteam_score_post, posteam_score_post, total_home_score, total_away_score,
           epa, yardline_100, ydstogo, first_down_rush, first_down_pass, kick_distance, run_location)
}

#map variable types for sub-selection


variable_types <- c(
  # Numeric variables
  play_id = "numeric",
  yardline_100 = "numeric",
  quarter_seconds_remaining = "numeric",
  half_seconds_remaining = "numeric",
  game_seconds_remaining = "numeric",
  drive = "numeric",
  qtr = "numeric",
  down = "numeric",
  ydstogo = "numeric",
  ydsnet = "numeric",
  yards_gained = "numeric",
  air_yards = "numeric",
  yards_after_catch = "numeric",
  kick_distance = "numeric",
  home_timeouts_remaining = "numeric",
  away_timeouts_remaining = "numeric",
  posteam_timeouts_remaining = "numeric",
  defteam_timeouts_remaining = "numeric",
  total_home_score = "numeric",
  total_away_score = "numeric",
  posteam_score = "numeric",
  defteam_score = "numeric",
  score_differential = "numeric",
  posteam_score_post = "numeric",
  defteam_score_post = "numeric",
  score_differential_post = "numeric",
  fumble_recovery_1_yards = "numeric",
  fumble_recovery_2_yards = "numeric",
  return_yards = "numeric",
  penalty_yards = "numeric",

  # EPA and WPA metrics
  no_score_prob = "numeric",
  opp_fg_prob = "numeric",
  opp_safety_prob = "numeric",
  opp_td_prob = "numeric",
  fg_prob = "numeric",
  safety_prob = "numeric",
  td_prob = "numeric",
  extra_point_prob = "numeric",
  two_point_conversion_prob = "numeric",
  ep = "numeric",
  epa = "numeric",
  total_home_epa = "numeric",
  total_away_epa = "numeric",
  total_home_rush_epa = "numeric",
  total_away_rush_epa = "numeric",
  total_home_pass_epa = "numeric",
  total_away_pass_epa = "numeric",
  air_epa = "numeric",
  yac_epa = "numeric",
  wp = "numeric",
  def_wp = "numeric",
  home_wp = "numeric",
  away_wp = "numeric",
  wpa = "numeric",

  # Categorical variables
  game_id = "categorical",
  home_team = "categorical",
  away_team = "categorical",
  posteam = "categorical",
  posteam_type = "categorical",
  defteam = "categorical",
  side_of_field = "categorical",
  game_half = "categorical",
  play_type = "categorical",
  pass_length = "categorical",
  pass_location = "categorical",
  run_location = "categorical",
  run_gap = "categorical",
  field_goal_result = "categorical",
  extra_point_result = "categorical",
  two_point_conv_result = "categorical",
  timeout_team = "categorical",
  td_team = "categorical",
  passer_player_id = "categorical",
  passer_player_name = "categorical",
  receiver_player_id = "categorical",
  receiver_player_name = "categorical",
  rusher_player_id = "categorical",
  rusher_player_name = "categorical",

  # Binary variables as categorical
  quarter_end = "categorical",
  sp = "categorical",
  goal_to_go = "categorical",
  shotgun = "categorical",
  no_huddle = "categorical",
  punt_blocked = "categorical",
  touchdown = "categorical",
  interception = "categorical",
  fumble = "categorical",
  safety = "categorical",
  penalty = "categorical"
)

